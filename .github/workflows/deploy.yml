
name: Deploy to Firebase

on:
  push:
    branches: [ main, firebase-new-project ]
  pull_request:
    branches: [ main, firebase-new-project ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
      env:
        NEXT_PUBLIC_PROCESS_INGESTION_URL: ${{ secrets.NEXT_PUBLIC_PROCESS_INGESTION_URL }}
        NEXT_PUBLIC_ON_FILE_UPLOAD_URL: ${{ secrets.NEXT_PUBLIC_ON_FILE_UPLOAD_URL }}
        NEXT_PUBLIC_TRIGGER_DILIGENCE_URL: ${{ secrets.NEXT_PUBLIC_TRIGGER_DILIGENCE_URL }}
        NEXT_PUBLIC_PROCESS_DILIGENCE_URL: ${{ secrets.NEXT_PUBLIC_PROCESS_DILIGENCE_URL }}
        NEXT_PUBLIC_SCHEDULE_INTERVIEW_URL: ${{ secrets.NEXT_PUBLIC_SCHEDULE_INTERVIEW_URL }}
        NEXT_PUBLIC_RUN_DILIGENCE_URL: ${{ secrets.NEXT_PUBLIC_RUN_DILIGENCE_URL }}
        NEXT_PUBLIC_QUERY_DILIGENCE_URL: ${{ secrets.NEXT_PUBLIC_QUERY_DILIGENCE_URL }}
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
        NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
        NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID || '1:533015987350:web:d6080ff950f86137352eb7' }}
        NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
        NEXT_PUBLIC_GA_PROPERTY_ID: ${{ secrets.NEXT_PUBLIC_GA_PROPERTY_ID }}
        NEXT_PUBLIC_APP_NAME: ${{ secrets.NEXT_PUBLIC_APP_NAME }}
        NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Create Python virtual environment
      run: |
        cd functions
        python3.12 -m venv venv
        
    - name: Install Python dependencies
      run: |
        cd functions
        source venv/bin/activate
        pip install -r requirements.txt
        
    - name: Install Firebase CLI
      run: |
        npm install -g firebase-tools
        
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Deploy Cloud Functions with Perplexity API Key
      run: |
        # Deploy process_ingestion_task with Perplexity enrichment
        gcloud functions deploy process_ingestion_task \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=process_ingestion_task \
          --trigger-topic=document-ingestion-topic \
          --timeout=540s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        # Deploy run_diligence with Perplexity enrichment
        gcloud functions deploy run_diligence \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=run_diligence \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        # Deploy query_diligence with Perplexity enrichment
        gcloud functions deploy query_diligence \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=query_diligence \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=60s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        # Deploy other functions
        gcloud functions deploy on_file_upload \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=on_file_upload \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy trigger_diligence \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=trigger_diligence \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy process_diligence_task \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=process_diligence_task \
          --trigger-topic=diligence-topic \
          --timeout=540s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy schedule_ai_interview \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=schedule_ai_interview \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest,SENDGRID_API_KEY=SENDGRID_API_KEY:latest,SENDGRID_FROM_EMAIL=SENDGRID_FROM_EMAIL:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy ai_feedback \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=ai_feedback \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy validate_memo_data \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=validate_memo_data \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy validate_market_size \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=validate_market_size \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy validate_competitors \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=validate_competitors \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=60s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy check_memo \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=check_memo \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=60s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy start_ai_interview \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=start_ai_interview \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        gcloud functions deploy submit_interview_answer \
          --gen2 \
          --runtime=python312 \
          --region=asia-south1 \
          --source=functions \
          --entry-point=submit_interview_answer \
          --trigger-http \
          --allow-unauthenticated \
          --timeout=300s \
          --memory=1GB \
          --set-secrets=PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest \
          --set-env-vars=GOOGLE_CLOUD_PROJECT=veritas-472301,VERTEX_AI_LOCATION=asia-south1 \
          --quiet
          
        echo "✅ All Cloud Functions deployed with Perplexity API Key!"
        
    - name: Deploy to Firebase Hosting
      run: |
        firebase deploy --only hosting --token ${{ secrets.FIREBASE_TOKEN }}